- name: Get current user
  become: false
  shell: whoami
  register: username

- name: Disable SSH root login
  become: true
  shell: echo "\n#Added by Ansible\nPermitRootLogin no" >> /etc/ssh/sshd_config

- name: Only allow current user for ssh login
  become: true
  shell: echo "AllowUsers {{ username.stdout }}\n" >> /etc/ssh/sshd_config

- name: Adjust SSH client alive settings
  become: true
  shell: echo "ClientAliveInterval 120\nClientAliveCountMax 10\n" >> /etc/ssh/sshd_config

- name: Restart SSH daemon
  become: true
  shell: systemctl restart sshd

- name: Create .ssh directory
  file:
    path: ~/.ssh
    state: directory
    mode: 0700

- name: Copy authorized keys file
  copy:
    src: files/authorized_keys
    dest: ~/.ssh
    decrypt: yes
    mode: 0600

